/**
 * Firmware name: Seeed K1100 dev kit, hardware version: seeed_k1100_dev_kit, software version: V1.0.0
Fault on thread UIThread
===== Thread stack information =====
  addr: 2000e940    data: 200027e0
  addr: 2000e944    data: 20001e9c
  addr: 2000e948    data: 0000002c
  addr: 2000e94c    data: 000130f3
  addr: 2000e950    data: 00000000
  addr: 2000e954    data: 00000000
  addr: 2000e958    data: 00000200
  addr: 2000e95c    data: 2002f3f4
  addr: 2000e960    data: 00000000
  addr: 2000e964    data: 00000000
  addr: 2000e968    data: 00000200
  addr: 2000e96c    data: 2002f3f4
  addr: 2000e970    data: 00000000
  addr: 2000e974    data: 00000000
  addr: 2000e978    data: 00000200
  addr: 2000e97c    data: 2002f3f4
  addr: 2000e980    data: 00000000
  addr: 2000e984    data: 00000000
  addr: 2000e988    data: 00000200
  addr: 2000e98c    data: 2002f3f4
  addr: 2000e990    data: 00000000
  addr: 2000e994    data: 00000000
  addr: 2000e998    data: 00000200
  addr: 2000e99c    data: 2002f3f4
  addr: 2000e9a0    data: 00000000
  addr: 2000e9a4    data: 00000000
  addr: 2000e9a8    data: 00000200
  addr: 2000e9ac    data: 2002f3f4
  addr: 2000e9b0    data: 00000000
  addr: 2000e9b4    data: 00000000
  addr: 2000e9b8    data: 00000200
  addr: 2000e9bc    data: 2002f3f4
  addr: 2000e9c0    data: 00000000
  addr: 2000e9c4    data: 00000000
  addr: 2000e9c8    data: 00000200
  addr: 2000e9cc    data: 2002f3f4
  addr: 2000e9d0    data: 2002fe44
  addr: 2000e9d4    data: 00000054
  addr: 2000e9d8    data: 00000026
  addr: 2000e9dc    data: aaaaaaab
  addr: 2000e9e0    data: 4055aaaa
  addr: 2000e9e4    data: 00000004
  addr: 2000e9e8    data: 00000003
  addr: 2000e9ec    data: 00000000
  addr: 2000e9f0    data: 2000ec98
  addr: 2000e9f4    data: 00007903
  addr: 2000e9f8    data: a5a5a5a5
  addr: 2000e9fc    data: a5a5a5a5
  addr: 2000ea00    data: a5a5a5a5
  addr: 2000ea04    data: a5a5a5a5
  addr: 2000ea08    data: a5a5a5a5
  addr: 2000ea0c    data: a5a5a5a5
  addr: 2000ea10    data: 00000000
  addr: 2000ea14    data: 40504000
  addr: 2000ea18    data: a5a5a5a5
  addr: 2000ea1c    data: 0000002e
  addr: 2000ea20    data: 00000095
  addr: 2000ea24    data: 000000ea
  addr: 2000ea28    data: 72c234f7
  addr: 2000ea2c    data: 4020234f
  addr: 2000ea30    data: aaaaaaab
  addr: 2000ea34    data: 4035aaaa
  addr: 2000ea38    data: 0000002a
  addr: 2000ea3c    data: 000007e0
  addr: 2000ea40    data: 00000118
  addr: 2000ea44    data: 00000026
  addr: 2000ea48    data: 00000054
  addr: 2000ea4c    data: 0000009d
  addr: 2000ea50    data: 00000001
  addr: 2000ea54    data: 00000000
  addr: 2000ea58    data: 20014e88
  addr: 2000ea5c    data: 20000958
  addr: 2000ea60    data: a5a5a5a5
  addr: 2000ea64    data: 0012a5a5
  addr: 2000ea68    data: 00080000
  addr: 2000ea6c    data: 0095002e
  addr: 2000ea70    data: 0074010f
  addr: 2000ea74    data: 006b0118
  addr: 2000ea78    data: 00000000
  addr: 2000ea7c    data: 00000000
  addr: 2000ea80    data: 2002fdd8
  addr: 2000ea84    data: 2002fe68
  addr: 2000ea88    data: 2002fe68
  addr: 2000ea8c    data: 2002fbe0
  addr: 2000ea90    data: 2002fc54
  addr: 2000ea94    data: 2002fc60
  addr: 2000ea98    data: 00000000
  addr: 2000ea9c    data: 406fc000
  addr: 2000eaa0    data: 00000000
  addr: 2000eaa4    data: 402e0000
  addr: 2000eaa8    data: 0000001e
  addr: 2000eaac    data: 200000bc
  addr: 2000eab0    data: 0000001f
  addr: 2000eab4    data: 0074010f
  addr: 2000eab8    data: 006b0118
  addr: 2000eabc    data: 000007e0
  addr: 2000eac0    data: 20010001
  addr: 2000eac4    data: ffffffed
  addr: 2000eac8    data: 4054a001
  addr: 2000eacc    data: 15414000
  addr: 2000ead0    data: 0a602a11
  addr: 2000ead4    data: 04a000c0
  addr: 2000ead8    data: 409a2100
  addr: 2000eadc    data: 04264100
  addr: 2000eae0    data: 2a003248
  addr: 2000eae4    data: 00000000
  addr: 2000eae8    data: 00000000
  addr: 2000eaec    data: 00010001
  addr: 2000eaf0    data: 00000001
  addr: 2000eaf4    data: 2001000c
  addr: 2000eaf8    data: 00000000
  addr: 2000eafc    data: ff000000
  addr: 2000eb00    data: 00029b53
  addr: 2000eb04    data: 00000000
  addr: 2000eb08    data: 00000000
  addr: 2000eb0c    data: 40777000
  addr: 2000eb10    data: 00000000
  addr: 2000eb14    data: 40777000
  addr: 2000eb18    data: 00000000
  addr: 2000eb1c    data: 00000000
  addr: 2000eb20    data: 00000000
  addr: 2000eb24    data: 405f4000
  addr: 2000eb28    data: 00000003
  addr: 2000eb2c    data: 00007e75
  addr: 2000eb30    data: 2002f3e8
  addr: 2000eb34    data: 00000008
  addr: 2000eb38    data: 00000000
  addr: 2000eb3c    data: 00000000
  addr: 2000eb40    data: 00000200
  addr: 2000eb44    data: 2002f3f4
  addr: 2000eb48    data: 0000007c
  addr: 2000eb4c    data: 00000000
  addr: 2000eb50    data: 00000200
  addr: 2000eb54    data: 2002f3f4
  addr: 2000eb58    data: 32310030
  addr: 2000eb5c    data: 35320035
  addr: 2000eb60    data: 37330030
  addr: 2000eb64    data: 00000035
  addr: 2000eb68    data: 2001000c
  addr: 2000eb6c    data: 00000000
  addr: 2000eb70    data: ff000000
  addr: 2000eb74    data: 00029b53
  addr: 2000eb78    data: 00000000
  addr: 2000eb7c    data: 00006991
  addr: 2000eb80    data: 00000000
  addr: 2000eb84    data: 2002f848
  addr: 2000eb88    data: 2000ed28
  addr: 2000eb8c    data: 00000000
  addr: 2000eb90    data: 2002f848
  addr: 2000eb94    data: 20016b10
  addr: 2000eb98    data: 20016b10
  addr: 2000eb9c    data: 00006aa3
  addr: 2000eba0    data: 2002f694
  addr: 2000eba4    data: 2002f618
  addr: 2000eba8    data: 2002f818
  addr: 2000ebac    data: 2002f82c
  addr: 2000ebb0    data: 2002f618
  addr: 2000ebb4    data: 2002f618
  addr: 2000ebb8    data: 2002f818
  addr: 2000ebbc    data: 2002f82c
  addr: 2000ebc0    data: 2002f618
  addr: 2000ebc4    data: 2002f618
  addr: 2000ebc8    data: 2002f818
  addr: 2000ebcc    data: 2002f82c
  addr: 2000ebd0    data: 2002f618
  addr: 2000ebd4    data: 2002f618
  addr: 2000ebd8    data: 2002f818
  addr: 2000ebdc    data: 2002f82c
  addr: 2000ebe0    data: 2002f618
  addr: 2000ebe4    data: 2002f618
  addr: 2000ebe8    data: 2002f818
  addr: 2000ebec    data: 2002f82c
  addr: 2000ebf0    data: 2002f618
  addr: 2000ebf4    data: 2002f618
  addr: 2000ebf8    data: 2002f818
  addr: 2000ebfc    data: 2002f82c
  addr: 2000ec00    data: 2002f618
  addr: 2000ec04    data: 2002f618
  addr: 2000ec08    data: 2002f818
  addr: 2000ec0c    data: 2002f82c
  addr: 2000ec10    data: 2002f618
  addr: 2000ec14    data: 2002f618
  addr: 2000ec18    data: 2002f818
  addr: 2000ec1c    data: 2002f82c
  addr: 2000ec20    data: 2002f694
  addr: 2000ec24    data: 2002f618
  addr: 2000ec28    data: 2002f818
  addr: 2000ec2c    data: 2002f82c
  addr: 2000ec30    data: 00000000
  addr: 2000ec34    data: 00000001
  addr: 2000ec38    data: 00000000
  addr: 2000ec3c    data: 2000ed28
  addr: 2000ec40    data: 00000000
  addr: 2000ec44    data: 2002f848
  addr: 2000ec48    data: 20016b10
  addr: 2000ec4c    data: 200149c0
  addr: 2000ec50    data: 200149dc
  addr: 2000ec54    data: 00006ba5
  addr: 2000ec58    data: 2000ed28
  addr: 2000ec5c    data: 4054a001
  addr: 2000ec60    data: 15414000
  addr: 2000ec64    data: 2000ec98
  addr: 2000ec68    data: 200169a0
  addr: 2000ec6c    data: 00000000
  addr: 2000ec70    data: 20016b10
  addr: 2000ec74    data: 00000000
  addr: 2000ec78    data: 00000000
  addr: 2000ec7c    data: 200149c0
  addr: 2000ec80    data: 200149dc
  addr: 2000ec84    data: 000081b5
  addr: 2000ec88    data: 0000005a
  addr: 2000ec8c    data: 0000ffff
  addr: 2000ec90    data: 200169b0
  addr: 2000ec94    data: 2002f878
  addr: 2000ec98    data: 01040055
  addr: 2000ec9c    data: 0003000a
  addr: 2000eca0    data: 00030008
  addr: 2000eca4    data: 00000000
  addr: 2000eca8    data: a5a50008
  addr: 2000ecac    data: 0054002e
  addr: 2000ecb0    data: 000200ea
  addr: 2000ecb4    data: 15410002
  addr: 2000ecb8    data: 0000ce79
  addr: 2000ecbc    data: 04000001
  addr: 2000ecc0    data: 00000000
  addr: 2000ecc4    data: 00000000
  addr: 2000ecc8    data: 00000000
  addr: 2000eccc    data: 52030001
  addr: 2000ecd0    data: 00000000
  addr: 2000ecd4    data: 00000000
  addr: 2000ecd8    data: 08110001
  addr: 2000ecdc    data: 00024fa4
  addr: 2000ece0    data: 00000000
  addr: 2000ece4    data: 00000000
  addr: 2000ece8    data: 00000000
  addr: 2000ecec    data: 40340000
  addr: 2000ecf0    data: 00000000
  addr: 2000ecf4    data: 40540000
  addr: 2000ecf8    data: 0000001e
  addr: 2000ecfc    data: 20014bd0
  addr: 2000ed00    data: 20014bd4
  addr: 2000ed04    data: 20014bd4
  addr: 2000ed08    data: 20014e88
  addr: 2000ed0c    data: 00000000
  addr: 2000ed10    data: 20014e88
  addr: 2000ed14    data: 00000001
  addr: 2000ed18    data: 20014e8c
  addr: 2000ed1c    data: 00000000
  addr: 2000ed20    data: 00000000
  addr: 2000ed24    data: 00000000
  addr: 2000ed28    data: 2002f848
  addr: 2000ed2c    data: 2002f870
  addr: 2000ed30    data: 2002f870
  addr: 2000ed34    data: 8b827020
  addr: 2000ed38    data: 2a09080c
  addr: 2000ed3c    data: 200169a0
  addr: 2000ed40    data: 200169b0
  addr: 2000ed44    data: 20002314
  addr: 2000ed48    data: 200169b8
  addr: 2000ed4c    data: a5a5a5a5
  addr: 2000ed50    data: a5a5a5a5
  addr: 2000ed54    data: a5a5a5a5
  addr: 2000ed58    data: a5a5a5a5
  addr: 2000ed5c    data: 00005c01
  addr: 2000ed60    data: 00005b91
  addr: 2000ed64    data: 200169a0
  addr: 2000ed68    data: a5a5a5a5
  addr: 2000ed6c    data: a5a5a5a5
  addr: 2000ed70    data: a5a5a5a5
  addr: 2000ed74    data: 0000fbb5
  addr: 2000ed78    data: a5a5a5a5
  addr: 2000ed7c    data: a5a5a5a5
  addr: 2000ed80    data: a5a5a5a5
  addr: 2000ed84    data: 0000a321
  addr: 2000ed88    data: a5a5a5a5
  addr: 2000ed8c    data: a5a5a5a5
====================================
=================== Registers information ====================
  R0 : 2002f3f4  R1 : 00000200  R2 : 00000004  R3 : 0000001f
  R12: c0000000  LR : 00006af9  PC : 00006b2e  PSR: 21000000
===========================================

*/
#include "ui.h"

// inline function, 4byte uint8_t to float
void UI::uint8_to_float(uint8_t *data, float *destination) {
    uint32_t value =
        data[0] | ((uint32_t)data[1]) << 8 | ((uint32_t)data[2]) << 16 | ((uint32_t)data[1]) << 24;
    *reinterpret_cast<uint32_t *>(destination) = value;
}

UI::UI(TFT_eSPI &lcd, TFT_eSprite &display, SysConfig &config, Message &m1, Message &m2)
    : Thread("UIThread", 2048, 1), tft(lcd), spr(display), cfg(config), btnMail(m1),
      sensorMail(m2) {
    Start();
};

void UI::init() {
}

void UI::Run() {
    uint8_t nums;

    init();

    while (true) {
        nums = btnMail.Receive(&buff, 256, 0);
        if (nums > 0) {
            LOGSS.printf("btn Receive: %d ", nums);
            LOGSS.println(buff[0]);
        }

        nums = sensorMail.Receive(&sdata, 256, 0);
        if (nums > 0) {
            // for (size_t i = 0; i < sdata.size; i = i + 4) {
            //     LOGSS.printf("%d ", ((int32_t *)sdata.data)[i]);
            // }
            // temp_light = sdata.size;
            // temp_mic   = ((int32_t *)sdata.data)[sdata.size - 5];
            // LOGSS.printf("sensor Receive: %s %d %d\r\n", sdata.name, sdata.id, sdata.size);
            // LOGSS.printf("UI thread free memory: %d\r", xPortGetFreeHeapSize());
        }
        LOGSS.printf("UI Stacks Free Bytes Remaining %d\r\n", uxTaskGetStackHighWaterMark(GetHandle()));
        for (int i = 0; i < 3; i++) {
            (this->*page[i])();
            // Delay(Ticks::MsToTicks(100));
        }
    }
}

#define PIXEL 4 // Width of one letter
#define LEFT_SIDE 70
#define HIGHT_SIDE 47
const static unsigned int FONT_ROW_HEIGHT = 22; // The height of a letter

void UI::sense_1() {
    uint8_t random_num;
    spr.createSprite(320, 70);
    spr.setFreeFont(FSSB9);
    random_num = random(0, 3);
    switch (random_num)
    {
    case 0:
        spr.fillRect(4 * PIXEL, 0, 21 * PIXEL, FONT_ROW_HEIGHT + 15, tft.color565(135, 206, 235));
        spr.fillRect(30 * PIXEL, 0, 21 * PIXEL, FONT_ROW_HEIGHT + 15, TFT_WHITE);
        spr.fillRect(56 * PIXEL, 0, 21 * PIXEL, FONT_ROW_HEIGHT + 15, TFT_WHITE);
        break;
    case 1:
        spr.fillRect(4 * PIXEL, 0, 21 * PIXEL, FONT_ROW_HEIGHT + 15, TFT_WHITE);
        spr.fillRect(30 * PIXEL, 0, 21 * PIXEL, FONT_ROW_HEIGHT + 15, tft.color565(135, 206, 235));
        spr.fillRect(56 * PIXEL, 0, 21 * PIXEL, FONT_ROW_HEIGHT + 15, TFT_WHITE);
        break;
    case 2:
        spr.fillRect(4 * PIXEL, 0, 21 * PIXEL, FONT_ROW_HEIGHT + 15, TFT_WHITE);
        spr.fillRect(30 * PIXEL, 0, 21 * PIXEL, FONT_ROW_HEIGHT + 15, TFT_WHITE);
        spr.fillRect(56 * PIXEL, 0, 21 * PIXEL, FONT_ROW_HEIGHT + 15, tft.color565(135, 206, 235));
        break;
    default:
        break;
    }

    spr.setFreeFont(FSSB9);
    spr.setTextColor(TFT_BLACK);
    spr.drawString("Sense", 32, 11, GFXFF);
    spr.drawString("Process", 127, 11, GFXFF);
    spr.drawString("Network", 231, 11, GFXFF);
    spr.drawLine(0, 2 * FONT_ROW_HEIGHT, SCREEN_WIDTH, 2 * FONT_ROW_HEIGHT, TFT_WHITE);

    spr.pushSprite(0, 0);
    spr.deleteSprite();
}

void UI::sense_2() {
    uint8_t random_num;
    spr.createSprite(320, 25);
    spr.setFreeFont(FSSB9);
    spr.fillSprite(TFT_BLACK);
    random_num = random(0, 3);
    switch (random_num)
    {
    case 0:
        spr.setTextColor(TFT_RED);
        spr.drawString("OFF", 90, 0, GFXFF);
        break;
    case 1:
        spr.setTextColor(TFT_GREEN, TFT_BLACK);           // Networking status indication：ON
        spr.drawString("LoRa(SenseCAP)", 90, 0, GFXFF); // Show the network you are in
        break;
    case 2:
        spr.setTextColor(TFT_GREEN, TFT_BLACK);          // Networking status indication：ON
        spr.drawString("WIFI(Ubidots)", 90, 0, GFXFF); // Show the network you are in
        break;
    default:;
    }
    spr.setTextColor(TFT_WHITE);
    spr.drawString("Network :", 5, 0, GFXFF);
    spr.pushSprite(0, 215);
    spr.deleteSprite();
}


void UI::sense_3() {
    tft.fillRect(18, 78, 24, 90, TFT_WHITE);
    // if (line_chart_data.size() > LINE_DATA_MAX_SIZE) // keep the old line chart front
    // {
    //     line_chart_data.pop(); // this is used to remove the first read variable
    // }
    // line_chart_data.push(analogRead(WIO_MIC));

    // // 85 * 260 = 22100
    // auto content = line_chart(20, 80); //(x,y) where the line graph begins
    // content
    //     .height(85)
    //     .width(260)
    //     .based_on(0.0)      // Starting point of y-axis, must be a float
    //     .show_circle(false) // drawing a cirle at each point, default is on.
    //     .value(line_chart_data)        // passing through the data to line graph
    //     .max_size(LINE_DATA_MAX_SIZE)
    //     .color(TFT_GREEN) // Setting the color for the line
    //                       //        .backgroud(tft.color565(0,0,0)) // Setting the color for the backgroud
    //     .backgroud(tft.color565(0, 0, 0))
    //     .draw(&tft);
}